# -*- mode: shell-script; -*-
# .bashrc
# for non-login shell.
# eg. new terminal window, inside screen or tmux

[[ $- != *i* ]] && return 0

if [ -z "$USERBASHRCSOURCED" ]; then
    USERBASHRCSOURCED="Y"

    # Source global definitions
    if [ -f /etc/bashrc ]; then
        . /etc/bashrc
    fi

    # Uncomment the following line if you don't like systemctl's auto-paging feature:
    # export SYSTEMD_PAGER=

    function command_exists () {
	    command -v "$1" >/dev/null 2>&1;
    }

    # User specific aliases and functions
    if command_exists realpath; then
        BASHRC_PATH=$(realpath ~/.bashrc)
    else
        BASHRC_PATH=$(readlink ~/.bashrc)
    fi
    BASHRC_DIR=$(dirname "$BASHRC_PATH")

    [ -f "${BASHRC_DIR}/functions.sh" ] && source "${BASHRC_DIR}/functions.sh"
    [ -f "${BASHRC_DIR}/alias.sh" ] && source "${BASHRC_DIR}/alias.sh"

    unset -v BASHRC_PATH

    if command_exists pathmunge; then
        # add binary PATH
        [ -d $HOME/.bin ] && pathmunge $HOME/.bin
        [ -d $HOME/bin ] && pathmunge $HOME/bin
        [ -d $HOME/.local/bin ] && pathmunge $HOME/.local/bin

        # flatpak bin
        if [ -d /var/lib/flatpak/exports/bin ]; then
            pathmunge /var/lib/flatpak/exports/bin
        fi

        # Rust bin
        if [ -d $HOME/.cargo/bin ]; then
            pathmunge $HOME/.cargo/bin
        fi
    fi

    if command_exists remove_dups_path; then
       # Path remove duplicates
       PATH=$(remove_dups_path "$PATH")
    fi

    # Update LINES & COLUMNS
    shopt -s checkwinsize

    # Multi-line command
    shopt -s cmdhist

    # Prevent execution of wrong command
    shopt -s histverify

    # Auto cd


    # History
    shopt -s histappend
    SAVEHIST=1000000000
    HISTSIZE=-1
    HISTFILESIZE=-1
    HISTFILE=~/.bash_history
    HISTCONTROL=ignoreboth

    # History to ignore: history command, preceding space char, duplicates
    HISTIGNORE="history*:[ \t]*:&"

    # Ignore common commands
    HISTIGNORE="$HISTIGNORE:pwd:ls:cd"

    if ((BASH_VERSINFO[0] > 4)); then
        # Auto cd
        shopt -s autocd
    fi
fi
